import{r as I,C as N,j as l}from"./index-BO-fgaC1.js";import{F as w,U as M,a as D}from"./FetchData-DGwEyyRR.js";const U=()=>{let n=new Map;return async(d,c)=>{const r=JSON.stringify(c);if(n.has(r)){const s=n.get(r);return console.log("from cache useGetFilter"),s}else{console.log("miss cache useGetFilter");const s=await w(d,{action:"filter",params:c});return n.set(r,s.result),s.result}}},J=()=>{let n=new Map;return async(d,c)=>{const r=JSON.stringify(c);if(n.has(r)){const s=n.get(r);return console.log("from cache useGetIds"),s}else{console.log("miss cache useGetIds");const s=await w(d,{action:"get_ids",params:{offset:c*50,limit:50}}),t=M(s.result);return n.set(r,t),t}}},O=()=>{let n=new Map;return async(d,c)=>{const r=JSON.stringify(c);if(n.has(r)){const s=n.get(r);return console.log("from cache useGetItemsById"),s}else{console.log("miss cache useGetItemsById");const s=await w(d,{action:"get_items",params:{ids:c}}),t=D(s.result);return n.set(r,t),t}}},R="_cardContainer_1oxl0_3",b="_Card_1oxl0_41",G={cardContainer:R,Card:b},_=U(),k=J(),C=O();function q({pages:n}){const[d,c]=I.useState([]),[r,s]=I.useState(!0),{state:t,dispatch:H}=I.useContext(N),S=()=>t.app.providers.length>0,B=()=>{const a=t.app.price_range;return a.min!==a.defMin||a.max!==a.defMax},j=()=>t.app.search!=="",P=({items:a})=>l.jsx("div",{className:G.cardContainer,children:a.map(i=>l.jsxs("div",{className:G.Card,children:[l.jsxs("span",{children:["Id: ",i.id]}),l.jsxs("span",{children:["Название: ",i.product]}),l.jsxs("span",{children:["Бренд: ",i.brand?i.brand:"Отсутствует"]}),l.jsxs("span",{children:["Цена: ",i.price," Рублей"]})]},i.id))}),v=async(a,i)=>{try{let e=[];if(S()){const m=t.app.providers.map(u=>_(a,{brand:u}));await Promise.all(m).then(u=>{let o=[];return u.forEach(x=>{o.push(...x)}),o=M(o),C(a,o)}).then(u=>{if(u.forEach(g=>{e.push(g)}),j()){const g=t.app.search;e=e.filter(h=>{if(h.product.toLowerCase().includes(g.toLowerCase()))return h})}let o=n*50;o>e.length&&s(!1),console.log("Общее количество товаров: ",e.length);const x=o+50>e.length?e.length:o+50;let p=[];for(;o<x;)p.push(e[o]),o++;return console.log("Товары ",p),p})}if(j()){const m=await _(a,{product:t.app.search});console.log("++++++++Ids ",m),(await C(a,m)).forEach(h=>{e.push(h)});const o=t.app.search;e=e.filter(h=>{if(h.product.toLowerCase().includes(o.toLowerCase()))return h});let p=n*50;p>e.length&&s(!1),console.log("Общее количество товаров: ",e.length);const g=p+50>e.length?e.length:p+50;let y=[];for(;p<g;)y.push(e[p]),p++;return console.log("Товары ",y),y}const f=await k(a,i);return e=await C(a,f),console.log("Товары ",e),e}catch(e){return console.log("Случилась ошибка запроса:",e.message),console.log("Попытка повторного запроса"),v("http://api.valantis.store:40000/",i)}},F=()=>{s(!0),c([]),v("https://api.valantis.store:41000/",n).then(a=>{if(B()){const i=t.app.price_range,e=a.filter(f=>{if(f.price>=i.min&&f.price<=i.max)return f});e.length>0&&c(e),s(!1)}else c(a),s(!1)})};I.useEffect(()=>{F()},[n,t.app.providers,t.app.price_range,t.app.search]);const E=()=>l.jsxs("div",{children:[JSON.stringify(t),l.jsx(P,{items:d})]}),L=()=>d.length>0?l.jsx(E,{}):r?l.jsx("h3",{children:"Загрузка..."}):l.jsx("h3",{children:"Нет данных по заданным критериям"});return l.jsx(L,{})}export{q as default};
